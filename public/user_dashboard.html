<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Eco Flow</title>
    <link rel="stylesheet" href="css/dashboard-new.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="css/logo_ecoflow.png" alt="Eco Flow Logo" class="sidebar-logo">
                <a href="login.html" class="sidebar-brand">Eco Flow</a>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section-title">Navigation</div>
                <a href="#dashboard" class="nav-item active" data-section="dashboard">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="#analytics" class="nav-item" data-section="analytics">
                    <span class="nav-icon">üìà</span>
                    <span>Analytics</span>
                </a>
                <a href="#controls" class="nav-item" data-section="controls">
                    <span class="nav-icon">üéõÔ∏è</span>
                    <span>Manual Controls</span>
                </a>
                <a href="#chatbot" class="nav-item" data-section="chatbot">
                    <span class="nav-icon">ü§ñ</span>
                    <span>AI Chatbot</span>
                </a>
            </nav>
            
            <div class="sidebar-user">
                <div class="user-profile">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="user-name">User</div>
                        <div class="user-role" id="user-role">User</div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="dashboard-main">
            <header class="dashboard-header">
                <h1 class="dashboard-title">Welcome to Eco Flow Dashboard</h1>
            </header>
            
            <div class="dashboard-content">
                <div id="alert-container"></div>
                
                <!-- Widget Grid -->
                <div class="widget-grid">
                    <!-- Air Temperature Widget -->
                    <div class="widget-card sensor-card" id="temp-card">
                        <div class="widget-header">
                            <div class="widget-title">AIR TEMPERATURE</div>
                            <div class="widget-value" id="temperature">--</div>
                            <div class="widget-trend">
                                <span class="trend-icon trend-stable">‚Üí</span>
                                <span id="temp-status">Loading...</span>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="temp-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    
                    <!-- Air Humidity Widget -->
                    <div class="widget-card sensor-card" id="humidity-card">
                        <div class="widget-header">
                            <div class="widget-title">AIR HUMIDITY</div>
                            <div class="widget-value" id="humidity">--</div>
                            <div class="widget-trend">
                                <span class="trend-icon trend-stable">‚Üí</span>
                                <span id="humidity-status">Loading...</span>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="humidity-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    
                    <!-- Soil Moisture Widget 1 -->
                    <div class="widget-card" id="soil1-card">
                        <div class="widget-header">
                            <div>
                                <div class="widget-title">Soil Moisture Sensor 1</div>
                                <div class="widget-value" id="soil1">--</div>
                                <div class="widget-trend">
                                    <span id="soil1-status">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="soil1-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    
                    <!-- Soil Moisture Widget 2 -->
                    <div class="widget-card" id="soil2-card">
                        <div class="widget-header">
                            <div>
                                <div class="widget-title">Soil Moisture Sensor 2</div>
                                <div class="widget-value" id="soil2">--</div>
                                <div class="widget-trend">
                                    <span id="soil2-status">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="soil2-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    
                    <!-- Soil Moisture Widget 3 -->
                    <div class="widget-card" id="soil3-card">
                        <div class="widget-header">
                            <div>
                                <div class="widget-title">Soil Moisture Sensor 3</div>
                                <div class="widget-value" id="soil3">--</div>
                                <div class="widget-trend">
                                    <span id="soil3-status">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="soil3-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    
                    <!-- System Status Widget -->
                    <div class="widget-card widget-large status-widget">
                        <div class="widget-header">
                            <div class="widget-title">System Status</div>
                        </div>
                        <div class="status-widget">
                            <div class="status-item">
                                <div class="status-label">Irrigation Valve</div>
                                <div class="status-indicator" id="valve-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">--</span>
                                </div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Water Pump</div>
                                <div class="status-indicator" id="pump-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">--</span>
                                </div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Water Level Status</div>
                                <div class="status-indicator" id="water-low-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">--</span>
                                </div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Water Tank Level</div>
                                <div class="status-indicator" id="water-high-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Historical Trends Section -->
                <div class="dashboard-section" id="analytics-section">
                    <h2 class="section-title">Historical Trends</h2>
                    <p class="section-description">View trends over the last 24 hours.</p>
                    <div class="chart-container">
                        <canvas id="soilChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="environmentChart"></canvas>
                    </div>
                </div>
                
                <!-- Manual Controls Section -->
                <div class="dashboard-section" id="controls-section">
                    <h2 class="section-title">Manual Controls</h2>
                    <p class="section-description">What are Manual Controls? Manual controls allow you to override the automatic irrigation system and manually operate the water pump and valve when needed. This is useful for testing, maintenance, or when you want to water your plants immediately.</p>
                    
                    <!-- How to Use Box -->
                    <div class="manual-controls-instructions">
                        <div class="instructions-header">
                            <span class="instructions-icon">üìã</span>
                            <span class="instructions-title">How to Use:</span>
                        </div>
                        <ol class="instructions-list">
                            <li>Click the toggle switch on any control card to turn it ON or OFF</li>
                            <li>The switch will show "Active" when the device is running</li>
                            <li>Monitor the status indicator to see if the command was successful</li>
                            <li>Remember to turn OFF manual controls when done to return to automatic mode</li>
                        </ol>
                    </div>
                    
                    <!-- Status Legend -->
                    <div class="status-legend">
                        <div class="legend-item">
                            <span class="legend-dot legend-green"></span>
                            <span class="legend-text">Green: Device is active and running</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot legend-yellow"></span>
                            <span class="legend-text">Yellow: Command is pending</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot legend-gray"></span>
                            <span class="legend-text">Gray: Device is inactive</span>
                        </div>
                    </div>
                    
                    <div class="control-panel">
                        <div class="control-card">
                            <div class="control-header">
                                <div class="control-icon-wrapper">
                                    <span class="control-icon">üö∞</span>
                                </div>
                                <div class="control-title-group">
                                    <h3 class="control-title">Water Pump</h3>
                                    <div class="control-status-badge" id="pump-status-badge">
                                        <span class="status-dot-indicator"></span>
                                        <span class="status-text-small">Inactive</span>
                                    </div>
                                </div>
                            </div>
                            
                            <p class="control-description">Manually activate the sprinkler system Click the switch to turn on the water pump and start watering your plants through the sprinkler system.</p>
                            
                            <div class="control-toggle-container">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="pump-toggle" onchange="handleToggle('pump', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="toggle-label" id="pump-toggle-label">Click to start sprinkler</span>
                            </div>
                            
                            <div class="control-status-info" id="pump-status-display">
                                <div class="status-info-row">
                                    <span class="status-label">Current State:</span>
                                    <span class="status-value" id="pump-status-value">OFF</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="control-card">
                            <div class="control-header">
                                <div class="control-icon-wrapper">
                                    <span class="control-icon">üíß</span>
                                </div>
                                <div class="control-title-group">
                                    <h3 class="control-title">Solenoid Valve</h3>
                                    <div class="control-status-badge" id="valve-status-badge">
                                        <span class="status-dot-indicator"></span>
                                        <span class="status-text-small">Inactive</span>
                                    </div>
                                </div>
                            </div>
                            
                            <p class="control-description">Manually fill the water tank Click the switch to open the valve and fill the water tank. This ensures you have enough water for irrigation.</p>
                            
                            <div class="control-toggle-container">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="valve-toggle" onchange="handleToggle('valve', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="toggle-label" id="valve-toggle-label">Click to fill tank</span>
                            </div>
                            
                            <div class="control-status-info" id="valve-status-display">
                                <div class="status-info-row">
                                    <span class="status-label">Current State:</span>
                                    <span class="status-value" id="valve-status-value">OFF</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <p id="last-update" class="last-update"></p>
                
                <div style="text-align: center; margin-top: var(--space-2xl);">
                    <button class="btn-logout" onclick="logout()">Logout</button>
                </div>
            </div>
        </main>
        
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">‚ò∞</button>
    </div>
    
    <script>
        let soilChart = null;
        let environmentChart = null;

        function logout() {
            localStorage.removeItem('userToken');
            localStorage.removeItem('userRole');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }

        function getSoilMoistureStatus(value) {
            if (value === null || value === undefined) return { status: 'unknown', class: '', text: 'No data' };
            if (value < 20) return { status: 'low', class: 'low', text: 'Very Dry - Needs Water' };
            if (value < 40) return { status: 'medium', class: 'medium', text: 'Dry - Monitor Closely' };
            if (value < 70) return { status: 'good', class: 'good', text: 'Optimal' };
            return { status: 'excellent', class: 'excellent', text: 'Well Hydrated' };
        }

        function getTemperatureStatus(value) {
            if (value === null || value === undefined) return { status: 'unknown', text: 'No data' };
            if (value < 10) return { status: 'cold', text: 'Cold' };
            if (value < 20) return { status: 'cool', text: 'Cool' };
            if (value < 30) return { status: 'optimal', text: 'Optimal' };
            if (value < 35) return { status: 'warm', text: 'Warm' };
            return { status: 'hot', text: 'Hot - Monitor' };
        }

        function getHumidityStatus(value) {
            if (value === null || value === undefined) return { status: 'unknown', text: 'No data' };
            if (value < 30) return { status: 'low', text: 'Low Humidity' };
            if (value < 60) return { status: 'optimal', text: 'Optimal' };
            return { status: 'high', text: 'High Humidity' };
        }

        function updateProgressBar(elementId, value, statusClass) {
            const bar = document.getElementById(elementId);
            if (bar) {
                if (value !== null && value !== undefined && value > 0) {
                    bar.style.width = `${Math.min(100, Math.max(0, value))}%`;
                    bar.textContent = `${Math.round(value)}%`;
                    bar.className = `progress-bar ${statusClass}`;
                    bar.style.opacity = '1'; // Full opacity when data is available
                } else {
                    // Loading state
                    bar.style.width = '0%';
                    bar.textContent = '0%';
                    bar.className = 'progress-bar';
                    bar.style.opacity = '0.4'; // Reduced opacity for loading state
                }
            }
        }

        function updateStatusIndicator(elementId, isActive, isWarning = false) {
            const indicator = document.getElementById(elementId);
            if (indicator) {
                const dot = indicator.querySelector('.status-dot');
                const text = indicator.querySelector('span:last-child');
                
                if (isWarning) {
                    indicator.className = 'status-indicator warning';
                    dot.className = 'status-dot warning';
                    text.textContent = 'Warning';
                } else if (isActive) {
                    indicator.className = 'status-indicator active';
                    dot.className = 'status-dot active';
                    text.textContent = 'Active';
                } else {
                    indicator.className = 'status-indicator inactive';
                    dot.className = 'status-dot inactive';
                    text.textContent = 'Inactive';
                }
            }
        }

        function updateWaterLevelStatus(elementId, isLow, isHigh = false) {
            const indicator = document.getElementById(elementId);
            if (indicator) {
                const dot = indicator.querySelector('.status-dot');
                const text = indicator.querySelector('span:last-child');
                
                if (elementId === 'water-low-status') {
                    // For low water level: 1 = Low (warning), 0 = OK
                    if (isLow === 1) {
                        indicator.className = 'status-indicator warning';
                        dot.className = 'status-dot warning';
                        text.textContent = 'Low';
                    } else {
                        indicator.className = 'status-indicator active';
                        dot.className = 'status-dot active';
                        text.textContent = 'OK';
                    }
                } else if (elementId === 'water-high-status') {
                    // CPE: high=upper sensor. 0=submerged (Full), 1=dry (Not Full)
                    if (isHigh === 0) {
                        indicator.className = 'status-indicator active';
                        dot.className = 'status-dot active';
                        text.textContent = 'Full';
                    } else {
                        indicator.className = 'status-indicator inactive';
                        dot.className = 'status-dot inactive';
                        text.textContent = 'Not Full';
                    }
                }
            }
        }

        function checkAlerts(data) {
            const alerts = [];
            
            // Check soil moisture
            [data.soil_moisture_1_percent, data.soil_moisture_2_percent, data.soil_moisture_3_percent].forEach((val, idx) => {
                if (val !== null && val < 20) {
                    alerts.push({ type: 'danger', message: `‚ö†Ô∏è Soil Sensor ${idx + 1} is very dry (${val}%) - Immediate watering recommended!` });
                } else if (val !== null && val < 30) {
                    alerts.push({ type: 'warning', message: `‚ö†Ô∏è Soil Sensor ${idx + 1} is dry (${val}%) - Consider watering soon.` });
                }
            });
            
            // Check temperature
            if (data.air_temperature_celsius !== null && data.air_temperature_celsius > 35) {
                alerts.push({ type: 'warning', message: `üå°Ô∏è High temperature detected (${data.air_temperature_celsius}¬∞C) - Monitor plant stress.` });
            }
            
            // Check water level
            if (data.water_level_low_status === 1) {
                alerts.push({ type: 'danger', message: 'üö® Water level is LOW - Refill water reservoir immediately!' });
            }
            
            return alerts;
        }

        function displayAlerts(alerts) {
            const container = document.getElementById('alert-container');
            if (alerts.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = alerts.map(alert => 
                `<div class="alert-banner ${alert.type} show">
                    ${alert.message}
                </div>`
            ).join('');
        }

        function updateSensorDisplay(data) {
            // Temperature
            const temp = data.air_temperature_celsius;
            const tempNum = temp !== null && temp !== undefined ? Number(temp) : null;
            const tempElement = document.getElementById('temperature');
            if (tempElement) {
                tempElement.textContent = tempNum !== null && !isNaN(tempNum) ? `${tempNum}¬∞C` : 'N/A';
            }
            const tempStatus = getTemperatureStatus(tempNum);
            const tempStatusElement = document.getElementById('temp-status');
            if (tempStatusElement) {
                tempStatusElement.textContent = tempStatus.text;
            }
            
            // Update temperature progress bar (normalize to 0-100% based on typical range 0-50¬∞C)
            if (tempNum !== null && !isNaN(tempNum)) {
                const tempPercent = Math.min(100, Math.max(0, (tempNum / 50) * 100));
                updateProgressBar('temp-bar', tempPercent, 'good');
            } else {
                updateProgressBar('temp-bar', 0, '');
            }
            
            // Humidity
            const humidity = data.air_humidity_percent;
            const humidityNum = humidity !== null && humidity !== undefined ? Number(humidity) : null;
            const humidityElement = document.getElementById('humidity');
            if (humidityElement) {
                humidityElement.textContent = humidityNum !== null && !isNaN(humidityNum) ? `${humidityNum.toFixed(1)}%` : 'N/A';
            }
            const humidityStatus = getHumidityStatus(humidityNum);
            const humidityStatusElement = document.getElementById('humidity-status');
            if (humidityStatusElement) {
                humidityStatusElement.textContent = humidityStatus.text;
            }
            
            // Update humidity progress bar (already in percentage)
            if (humidityNum !== null && !isNaN(humidityNum)) {
                updateProgressBar('humidity-bar', humidityNum, 'good');
            } else {
                updateProgressBar('humidity-bar', 0, '');
            }
            
            // Soil Moisture Sensors
            const soil1 = data.soil_moisture_1_percent;
            const soil2 = data.soil_moisture_2_percent;
            const soil3 = data.soil_moisture_3_percent;
            
            [soil1, soil2, soil3].forEach((val, idx) => {
                const num = idx + 1;
                const soilNum = val !== null && val !== undefined ? Number(val) : null;
                const soilElement = document.getElementById(`soil${num}`);
                if (soilElement) {
                    soilElement.textContent = soilNum !== null && !isNaN(soilNum) ? `${soilNum.toFixed(2)}%` : 'N/A';
                }
                
                const soilStatus = getSoilMoistureStatus(soilNum);
                const soilStatusElement = document.getElementById(`soil${num}-status`);
                if (soilStatusElement) {
                    soilStatusElement.textContent = soilStatus.text;
                }
                updateProgressBar(`soil${num}-bar`, soilNum !== null && !isNaN(soilNum) ? soilNum : 0, soilStatus.class);
                
                // Update card border color
                const card = document.getElementById(`soil${num}-card`);
                if (card) {
                    if (soilStatus.class === 'low') {
                        card.style.borderLeftColor = '#f44336';
                    } else if (soilStatus.class === 'medium') {
                        card.style.borderLeftColor = '#ff9800';
                    } else {
                        card.style.borderLeftColor = 'var(--green-medium)';
                    }
                }
            });
            
            // System Status
            updateStatusIndicator('valve-status', data.valve_status === 1);
            updateStatusIndicator('pump-status', data.pump_status === 1);
            updateWaterLevelStatus('water-low-status', data.water_level_low_status);
            updateWaterLevelStatus('water-high-status', null, data.water_level_high_status);
            
            // Last update
            if (data.timestamp) {
                const updateTime = new Date(data.timestamp).toLocaleString();
                document.getElementById('last-update').textContent = `Last updated: ${updateTime}`;
            }
            
            // Alerts
            const alerts = checkAlerts(data);
            displayAlerts(alerts);
        }

        function initializeCharts() {
            const soilCtx = document.getElementById('soilChart');
            const envCtx = document.getElementById('environmentChart');
            
            if (soilCtx) {
                soilChart = new Chart(soilCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'Sensor 1', data: [], borderColor: '#43a047', backgroundColor: 'rgba(67, 160, 71, 0.1)', tension: 0.4 },
                            { label: 'Sensor 2', data: [], borderColor: '#1e88e5', backgroundColor: 'rgba(30, 136, 229, 0.1)', tension: 0.4 },
                            { label: 'Sensor 3', data: [], borderColor: '#ff9800', backgroundColor: 'rgba(255, 152, 0, 0.1)', tension: 0.4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: { display: true, text: 'Soil Moisture Trends (%) - Hourly Average', font: { size: 16 } },
                            legend: { display: true }
                        },
                        scales: {
                            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Moisture %' } },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    maxTicksLimit: 12
                                }
                            }
                        }
                    }
                });
            }
            
            if (envCtx) {
                environmentChart = new Chart(envCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'Temperature (¬∞C)', data: [], borderColor: '#f44336', backgroundColor: 'rgba(244, 67, 54, 0.1)', yAxisID: 'y', tension: 0.4 },
                            { label: 'Humidity (%)', data: [], borderColor: '#2196f3', backgroundColor: 'rgba(33, 150, 243, 0.1)', yAxisID: 'y1', tension: 0.4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: { display: true, text: 'Temperature & Humidity Trends - Hourly Average', font: { size: 16 } },
                            legend: { display: true }
                        },
                        scales: {
                            y: { type: 'linear', position: 'left', title: { display: true, text: 'Temperature (¬∞C)' } },
                            y1: { type: 'linear', position: 'right', title: { display: true, text: 'Humidity (%)' }, grid: { drawOnChartArea: false } },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    maxTicksLimit: 12
                                }
                            }
                        }
                    }
                });
            }
        }

        function aggregateByHour(data) {
            // Group data by hour
            const hourlyData = {};
            
            data.forEach(d => {
                const date = new Date(d.timestamp);
                // Create hour key: YYYY-MM-DD-HH
                const hourKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}-${String(date.getHours()).padStart(2, '0')}`;
                
                if (!hourlyData[hourKey]) {
                    hourlyData[hourKey] = {
                        timestamp: d.timestamp,
                        hourLabel: date.toLocaleString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }),
                        soil1: [],
                        soil2: [],
                        soil3: [],
                        temperature: [],
                        humidity: []
                    };
                }
                
                // Collect values for averaging
                if (d.soil_moisture_1_percent !== null && d.soil_moisture_1_percent !== undefined) {
                    hourlyData[hourKey].soil1.push(Number(d.soil_moisture_1_percent));
                }
                if (d.soil_moisture_2_percent !== null && d.soil_moisture_2_percent !== undefined) {
                    hourlyData[hourKey].soil2.push(Number(d.soil_moisture_2_percent));
                }
                if (d.soil_moisture_3_percent !== null && d.soil_moisture_3_percent !== undefined) {
                    hourlyData[hourKey].soil3.push(Number(d.soil_moisture_3_percent));
                }
                if (d.air_temperature_celsius !== null && d.air_temperature_celsius !== undefined) {
                    hourlyData[hourKey].temperature.push(Number(d.air_temperature_celsius));
                }
                if (d.air_humidity_percent !== null && d.air_humidity_percent !== undefined) {
                    hourlyData[hourKey].humidity.push(Number(d.air_humidity_percent));
                }
            });
            
            // Calculate averages and create sorted array
            const aggregated = Object.keys(hourlyData)
                .sort()
                .map(key => {
                    const hour = hourlyData[key];
                    return {
                        timestamp: hour.timestamp,
                        label: hour.hourLabel,
                        soil1: hour.soil1.length > 0 ? hour.soil1.reduce((a, b) => a + b, 0) / hour.soil1.length : null,
                        soil2: hour.soil2.length > 0 ? hour.soil2.reduce((a, b) => a + b, 0) / hour.soil2.length : null,
                        soil3: hour.soil3.length > 0 ? hour.soil3.reduce((a, b) => a + b, 0) / hour.soil3.length : null,
                        temperature: hour.temperature.length > 0 ? hour.temperature.reduce((a, b) => a + b, 0) / hour.temperature.length : null,
                        humidity: hour.humidity.length > 0 ? hour.humidity.reduce((a, b) => a + b, 0) / hour.humidity.length : null
                    };
                });
            
            return aggregated;
        }

        function updateCharts(historyData) {
            if (!historyData || historyData.length === 0) return;
            
            // Aggregate data by hour for cleaner charts
            const hourlyData = aggregateByHour(historyData);
            
            const labels = hourlyData.map(d => d.label);
            
            if (soilChart) {
                soilChart.data.labels = labels;
                soilChart.data.datasets[0].data = hourlyData.map(d => d.soil1);
                soilChart.data.datasets[1].data = hourlyData.map(d => d.soil2);
                soilChart.data.datasets[2].data = hourlyData.map(d => d.soil3);
                soilChart.update();
            }
            
            if (environmentChart) {
                environmentChart.data.labels = labels;
                environmentChart.data.datasets[0].data = hourlyData.map(d => d.temperature);
                environmentChart.data.datasets[1].data = hourlyData.map(d => d.humidity);
                environmentChart.update();
            }
        }

        async function fetchSensorData() {
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                return;
            }

            try {
                // Fetch latest data
                const response = await fetch('/api/data/latest', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 404) {
                    document.getElementById('temperature').textContent = 'No data';
                    document.getElementById('humidity').textContent = 'No data';
                    ['soil1', 'soil2', 'soil3'].forEach(id => {
                        document.getElementById(id).textContent = 'No data';
                    });
                    document.getElementById('last-update').textContent = 'No sensor data available. Database is empty.';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to fetch sensor data');
                }

                const data = await response.json();
                updateSensorDisplay(data);
                
                // Fetch historical data for charts
                const historyResponse = await fetch('/api/data/history?hours=24', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (historyResponse.ok) {
                    const historyData = await historyResponse.json();
                    updateCharts(historyData);
                }

            } catch (error) {
                console.error('Error fetching sensor data:', error);
                document.getElementById('last-update').textContent = 'Error loading sensor data.';
            }
        }

        async function sendCommand(device, state) {
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                alert('Please log in to send commands.');
                return;
            }

            // Disable toggle during request
            const toggle = document.getElementById(`${device}-toggle`);
            const toggleLabel = document.getElementById(`${device}-toggle-label`);
            const originalLabel = toggleLabel?.textContent;
            
            if (toggle) toggle.disabled = true;
            if (toggleLabel) toggleLabel.textContent = 'Sending...';

            try {
                const response = await fetch('/api/commands/send', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ device, state })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to send command');
                }

                // Show success feedback
                updateCommandStatus(device, {
                    desired_state: state,
                    status: 'PENDING',
                    requested_at: new Date().toISOString()
                });

                // Refresh status immediately and then poll
                fetchCommandStatus();

            } catch (error) {
                console.error('Error sending command:', error);
                alert(`Failed to send command: ${error.message}`);
                // Revert toggle on error
                if (toggle) toggle.checked = state !== 'ON';
            } finally {
                // Re-enable toggle
                if (toggle) toggle.disabled = false;
                if (toggleLabel && originalLabel) toggleLabel.textContent = originalLabel;
            }
        }

        async function handleToggle(device, isOn) {
            const state = isOn ? 'ON' : 'OFF';
            await sendCommand(device, state);
        }

        function updateCommandStatus(device, commandData) {
            const statusValue = document.getElementById(`${device}-status-value`);
            const statusBadge = document.getElementById(`${device}-status-badge`);
            const toggle = document.getElementById(`${device}-toggle`);
            const toggleLabel = document.getElementById(`${device}-toggle-label`);
            const dotIndicator = statusBadge?.querySelector('.status-dot-indicator');
            const statusText = statusBadge?.querySelector('.status-text-small');
            
            if (!commandData) {
                if (statusValue) {
                    statusValue.textContent = 'OFF';
                    statusValue.className = 'status-value';
                }
                if (toggle) toggle.checked = false;
                if (toggleLabel) {
                    toggleLabel.textContent = device === 'pump' ? 'Click to start sprinkler' : 'Click to fill tank';
                }
                if (dotIndicator) {
                    dotIndicator.className = 'status-dot-indicator inactive';
                }
                if (statusText) statusText.textContent = 'Inactive';
                return;
            }
            
            // Format status display
            let statusTextValue = '';
            let statusClass = '';
            let isActive = false;
            let isPending = false;
            
            if (commandData.status === 'PENDING') {
                statusTextValue = 'Pending';
                statusClass = 'pending';
                isActive = commandData.desired_state === 'ON';
                isPending = true;
            } else if (commandData.status === 'SUCCESS') {
                statusTextValue = commandData.actual_state || commandData.desired_state;
                statusClass = 'success';
                isActive = (commandData.actual_state || commandData.desired_state) === 'ON';
            } else if (commandData.status === 'FAILED') {
                statusTextValue = 'Failed';
                statusClass = 'error';
                isActive = false;
            } else {
                statusTextValue = commandData.desired_state || 'OFF';
                statusClass = '';
                isActive = commandData.desired_state === 'ON';
            }

            // Update toggle switch
            if (toggle) {
                toggle.checked = isActive;
            }

            // Update status value
            if (statusValue) {
                statusValue.textContent = statusTextValue;
                statusValue.className = `status-value ${statusClass}`;
            }

            // Update status badge
            if (dotIndicator) {
                if (isPending) {
                    dotIndicator.className = 'status-dot-indicator';
                    dotIndicator.style.background = '#FFC107';
                } else if (isActive) {
                    dotIndicator.className = 'status-dot-indicator active';
                } else {
                    dotIndicator.className = 'status-dot-indicator inactive';
                }
            }
            
            if (statusText) {
                statusText.textContent = isPending ? 'Pending' : (isActive ? 'Active' : 'Inactive');
            }

            // Update toggle label
            if (toggleLabel) {
                if (device === 'pump') {
                    toggleLabel.textContent = isActive ? 'Sprinkler is running' : 'Click to start sprinkler';
                } else {
                    toggleLabel.textContent = isActive ? 'Tank is filling' : 'Click to fill tank';
                }
            }
        }

        async function fetchCommandStatus() {
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                return;
            }

            try {
                const response = await fetch('/api/commands/status', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch command status');
                }

                const data = await response.json();
                
                // Update pump status
                updateCommandStatus('pump', data.pump);
                
                // Update valve status
                updateCommandStatus('valve', data.valve);

            } catch (error) {
                console.error('Error fetching command status:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('userToken');
            const role = localStorage.getItem('userRole');

            if (!token || role !== 'user') {
                alert('Access Denied. Please log in as a User.');
                window.location.href = 'login.html';
                return;
            }

            // Mobile menu toggle
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                });
            }
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    sidebar && 
                    !sidebar.contains(e.target) && 
                    mobileMenuToggle &&
                    !mobileMenuToggle.contains(e.target) &&
                    sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            });
            
            // Navigation item clicks
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const section = this.getAttribute('data-section');
                    
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Handle special navigation cases
                    if (section === 'chatbot') {
                        window.location.href = 'chatbot.html';
                        return;
                    }
                    
                    if (section === 'dashboard') {
                        // Scroll to top of dashboard
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        return;
                    }
                    
                    // Scroll to section if it exists
                    const targetSection = document.getElementById(`${section}-section`);
                    if (targetSection) {
                        targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        console.warn(`Section "${section}-section" not found`);
                    }
                });
            });

            initializeCharts();
            fetchSensorData();
            fetchCommandStatus(); // Initial load of command status
            setInterval(fetchSensorData, 30000); // Update every 30 seconds
            setInterval(fetchCommandStatus, 10000); // Poll command status every 10 seconds
            
            // Chatbox Widget Functionality
            const floatingChatbotBtn = document.getElementById('floatingChatbotBtn');
            const chatboxWidget = document.getElementById('chatboxWidget');
            const chatboxClose = document.getElementById('chatboxClose');
            const chatboxOverlay = document.getElementById('chatboxOverlay');
            const chatboxInput = document.getElementById('chatboxInput');
            const chatboxSendBtn = document.getElementById('chatboxSendBtn');
            const chatboxMessages = document.getElementById('chatboxMessages');
            const chatboxExamples = document.getElementById('chatboxExamples');
            
            // Open chatbox
            if (floatingChatbotBtn) {
                floatingChatbotBtn.addEventListener('click', () => {
                    chatboxWidget.classList.add('active');
                    chatboxOverlay.classList.add('active');
                    chatboxInput.focus();
                });
            }
            
            // Close chatbox
            const closeChatbox = () => {
                chatboxWidget.classList.remove('active');
                chatboxOverlay.classList.remove('active');
            };
            
            if (chatboxClose) {
                chatboxClose.addEventListener('click', closeChatbox);
            }
            
            if (chatboxOverlay) {
                chatboxOverlay.addEventListener('click', closeChatbox);
            }
            
            // Example question clicks
            if (chatboxExamples) {
                chatboxExamples.querySelectorAll('.example-question').forEach(example => {
                    example.addEventListener('click', () => {
                        const question = example.getAttribute('data-question');
                        if (question) {
                            chatboxInput.value = question;
                            sendChatboxMessage(question);
                        }
                    });
                });
            }
            
            // Send message
            const sendChatboxMessage = (message) => {
                if (!message.trim()) return;
                
                // Add user message
                addChatboxMessage(message, false);
                
                // Hide examples
                if (chatboxExamples) {
                    chatboxExamples.style.display = 'none';
                }
                
                // Clear input
                if (chatboxInput) {
                    chatboxInput.value = '';
                }
                
                // Show loading
                const loadingId = addChatboxMessage('Thinking...', true, true);
                
                // Send to API
                const N8N_WEBHOOK_URL = '/api/chatbot';
                
                fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question: message,
                        message: message 
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Remove loading message
                    const loadingMsg = document.getElementById(loadingId);
                    if (loadingMsg) loadingMsg.remove();
                    
                    // Handle different response formats
                    let responseText = '';
                    if (data.response) {
                        responseText = data.response;
                    } else if (data.message) {
                        responseText = data.message;
                    } else if (data.answer) {
                        responseText = data.answer;
                    } else if (typeof data === 'string') {
                        responseText = data;
                    } else {
                        responseText = 'I apologize, but I couldn\'t process your request. Please try again.';
                    }
                    
                    // Add bot response
                    addChatboxMessage(responseText, true);
                })
                .catch(error => {
                    // Remove loading message
                    const loadingMsg = document.getElementById(loadingId);
                    if (loadingMsg) loadingMsg.remove();
                    
                    addChatboxMessage('Sorry, I encountered an error. Please try again later.', true);
                    console.error('Chatbot error:', error);
                });
            };
            
            // Escape HTML to prevent XSS (for user messages)
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            // Clean and format HTML response from bot (remove inline styles, convert to clean HTML)
            const cleanHtmlResponse = (html) => {
                if (!html) return '';
                
                // Create a temporary div to parse HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Remove inline styles from all elements
                const allElements = tempDiv.querySelectorAll('*');
                allElements.forEach(el => {
                    el.removeAttribute('style');
                });
                
                // Convert <br> tags to proper line breaks
                const brTags = tempDiv.querySelectorAll('br');
                brTags.forEach(br => {
                    br.replaceWith(document.createTextNode('\n'));
                });
                
                // Get text content and preserve line breaks
                let text = tempDiv.textContent || tempDiv.innerText || '';
                
                // Convert HTML tags to plain text formatting
                // Handle <strong> and <b> tags
                text = text.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
                text = text.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
                
                // Handle <p> tags - add line breaks
                text = text.replace(/<p[^>]*>/gi, '\n');
                text = text.replace(/<\/p>/gi, '\n');
                
                // Handle <br> and <br/> tags
                text = text.replace(/<br\s*\/?>/gi, '\n');
                
                // Remove remaining HTML tags
                text = text.replace(/<[^>]+>/g, '');
                
                // Decode HTML entities
                text = text.replace(/&nbsp;/g, ' ');
                text = text.replace(/&amp;/g, '&');
                text = text.replace(/&lt;/g, '<');
                text = text.replace(/&gt;/g, '>');
                text = text.replace(/&quot;/g, '"');
                
                // Clean up multiple line breaks
                text = text.replace(/\n{3,}/g, '\n\n');
                text = text.trim();
                
                // Convert **text** to <strong>text</strong> for rendering
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                // Convert line breaks to <br> tags
                text = text.replace(/\n/g, '<br>');
                
                return text;
            };
            
            // Add message to chatbox
            const addChatboxMessage = (text, isBot = false, isLoading = false) => {
                const messageId = 'msg-' + Date.now();
                const messageDiv = document.createElement('div');
                messageDiv.className = `chatbox-message ${isBot ? 'bot-message' : 'user-message'}`;
                messageDiv.id = messageId;
                
                if (isBot) {
                    // For bot messages, clean HTML and render it
                    const cleanedText = isLoading ? 'Thinking...' : cleanHtmlResponse(text);
                    messageDiv.innerHTML = `
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-content">
                            <div class="message-text">${cleanedText}</div>
                        </div>
                    `;
                } else {
                    // For user messages, escape HTML for security
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div class="message-text">${escapeHtml(text)}</div>
                        </div>
                    `;
                }
                
                if (chatboxMessages) {
                    chatboxMessages.appendChild(messageDiv);
                    chatboxMessages.scrollTop = chatboxMessages.scrollHeight;
                }
                
                return messageId;
            };
            
            // Send button click
            if (chatboxSendBtn) {
                chatboxSendBtn.addEventListener('click', () => {
                    if (chatboxInput && chatboxInput.value.trim()) {
                        sendChatboxMessage(chatboxInput.value);
                    }
                });
            }
            
            // Enter key to send
            if (chatboxInput) {
                chatboxInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && chatboxInput.value.trim()) {
                        sendChatboxMessage(chatboxInput.value);
                    }
                });
            }
        });
    </script>
    
    <!-- Floating Chatbot Button -->
    <button class="floating-chatbot-btn" id="floatingChatbotBtn" aria-label="Open AI Chatbot">
        <span class="chatbot-icon">üí¨</span>
        <span class="chatbot-tooltip">AI Chatbot</span>
    </button>
    
    <!-- Chatbox Widget -->
    <div class="chatbox-widget" id="chatboxWidget">
        <div class="chatbox-header">
            <div class="chatbox-header-content">
                <div class="chatbox-avatar">ü§ñ</div>
                <div class="chatbox-title-group">
                    <h3 class="chatbox-title">AI Irrigation Chatbot</h3>
                    <p class="chatbox-subtitle">Ask about your irrigation system</p>
                </div>
            </div>
            <button class="chatbox-close" id="chatboxClose" aria-label="Close chatbox">√ó</button>
        </div>
        
        <div class="chatbox-messages" id="chatboxMessages">
            <div class="chatbox-message bot-message">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="message-text">
                        Hello! I'm your AI irrigation assistant. I can help you with:
                        <ul>
                            <li>Current soil conditions and sensor readings</li>
                            <li>Crop suitability based on environmental data</li>
                            <li>Historical sensor data analysis</li>
                            <li>Irrigation schedule recommendations</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chatbox-examples" id="chatboxExamples">
            <div class="example-question" data-question="What is the current soil moisture level?">
                What is the current soil moisture level?
            </div>
            <div class="example-question" data-question="What crops are suitable for the current conditions?">
                What crops are suitable?
            </div>
            <div class="example-question" data-question="When should I water my plants?">
                When should I water my plants?
            </div>
        </div>
        
        <div class="chatbox-input-container">
            <input 
                type="text" 
                id="chatboxInput" 
                class="chatbox-input" 
                placeholder="Ask me about your irrigation system..."
                autocomplete="off"
            />
            <button id="chatboxSendBtn" class="chatbox-send-btn" aria-label="Send message">
                <span class="send-icon">üì§</span>
            </button>
        </div>
    </div>
    
    <div class="chatbox-overlay" id="chatboxOverlay"></div>
</body>
</html>

