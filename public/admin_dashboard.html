<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Eco Flow</title>
    <link rel="stylesheet" href="css/dashboard-new.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="css/logo_ecoflow.png" alt="Eco Flow Logo" class="sidebar-logo">
                <a href="login.html" class="sidebar-brand">Eco Flow</a>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section-title">Navigation</div>
                <a href="#dashboard" class="nav-item active" data-section="dashboard">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="#analytics" class="nav-item" data-section="analytics">
                    <span class="nav-icon">üìà</span>
                    <span>Analytics</span>
                </a>
                <a href="#users" class="nav-item" data-section="users">
                    <span class="nav-icon">üë•</span>
                    <span>User Management</span>
                </a>
                <a href="#controls" class="nav-item" data-section="controls">
                    <span class="nav-icon">üéõÔ∏è</span>
                    <span>Manual Controls</span>
                </a>
                <a href="#chatbot" class="nav-item" data-section="chatbot">
                    <span class="nav-icon">ü§ñ</span>
                    <span>AI Chatbot</span>
                </a>
                <a href="#reports" class="nav-item" data-section="reports">
                    <span class="nav-icon">üìÑ</span>
                    <span>Reports</span>
                </a>
            </nav>
            
            <div class="sidebar-user">
                <div class="user-profile">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="user-name">Admin User</div>
                        <div class="user-role" id="user-role">Administrator</div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="dashboard-main">
            <header class="dashboard-header">
                <h1 class="dashboard-title">Welcome to Eco Flow Dashboard</h1>
            </header>
            
            <div class="dashboard-content">
                <div id="alert-container"></div>
                
                <!-- Widget Grid -->
                <div class="widget-grid">
                    <!-- Air Temperature Widget -->
                    <div class="widget-card sensor-card" id="temp-card">
                        <div class="widget-header">
                            <div class="widget-title">AIR TEMPERATURE</div>
                            <div class="widget-value" id="temperature">--</div>
                            <div class="widget-trend">
                                <span class="trend-icon trend-stable">‚Üí</span>
                                <span id="temp-status">Loading...</span>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="temp-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    
                    <!-- Air Humidity Widget -->
                    <div class="widget-card sensor-card" id="humidity-card">
                        <div class="widget-header">
                            <div class="widget-title">AIR HUMIDITY</div>
                            <div class="widget-value" id="humidity">--</div>
                            <div class="widget-trend">
                                <span class="trend-icon trend-stable">‚Üí</span>
                                <span id="humidity-status">Loading...</span>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="humidity-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    
                    <!-- Soil Moisture Widget 1 -->
                    <div class="widget-card sensor-card" id="soil1-card">
                        <div class="widget-header">
                            <div class="widget-title">SOIL MOISTURE SENSOR 1</div>
                            <div class="widget-value" id="soil1">--</div>
                            <div class="widget-trend">
                                <span id="soil1-status">Loading...</span>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="soil1-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    
                    <!-- Soil Moisture Widget 2 -->
                    <div class="widget-card sensor-card" id="soil2-card">
                        <div class="widget-header">
                            <div class="widget-title">SOIL MOISTURE SENSOR 2</div>
                            <div class="widget-value" id="soil2">--</div>
                            <div class="widget-trend">
                                <span id="soil2-status">Loading...</span>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="soil2-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    
                    <!-- Soil Moisture Widget 3 -->
                    <div class="widget-card sensor-card" id="soil3-card">
                        <div class="widget-header">
                            <div class="widget-title">SOIL MOISTURE SENSOR 3</div>
                            <div class="widget-value" id="soil3">--</div>
                            <div class="widget-trend">
                                <span id="soil3-status">Loading...</span>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="soil3-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    
                    <!-- System Status Widget -->
                    <div class="widget-card widget-large" id="system-status-card">
                        <div class="widget-header">
                            <div class="widget-title">SYSTEM STATUS</div>
                        </div>
                        <div class="status-widget">
                            <div class="status-item">
                                <div class="status-label">Irrigation Valve</div>
                                <div class="status-indicator" id="valve-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">--</span>
                                </div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Water Pump</div>
                                <div class="status-indicator" id="pump-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">--</span>
                                </div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Water Level Status</div>
                                <div class="status-indicator" id="water-low-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">--</span>
                                </div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Water Tank Level</div>
                                <div class="status-indicator" id="water-high-status">
                                    <span class="status-dot"></span>
                                    <span class="status-text">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User Management Section -->
                <div class="dashboard-section" id="users-section">
                    <h2 class="section-title">User Management</h2>
                    <p class="section-description">Add and manage system users including gardeners and other administrators.</p>
                    <button class="btn-primary" onclick="window.location.href = 'registration.html'">
                        ‚ûï Register New User
                    </button>
                </div>
                
                <!-- Historical Trends Section -->
                <div class="dashboard-section" id="analytics-section">
                    <h2 class="section-title">Historical Trends</h2>
                    <p class="section-description">View trends over the last 24 hours.</p>
                    <div class="chart-container">
                        <canvas id="soilChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="environmentChart"></canvas>
                    </div>
                </div>
                
                <!-- Manual Controls Section -->
                <div class="dashboard-section" id="controls-section">
                    <h2 class="section-title">Manual Controls</h2>
                    <p class="section-description">What are Manual Controls? Manual controls allow you to override the automatic irrigation system and manually operate the water pump and valve when needed. This is useful for testing, maintenance, or when you want to water your plants immediately.</p>
                    
                    <!-- How to Use Box -->
                    <div class="manual-controls-instructions">
                        <div class="instructions-header">
                            <span class="instructions-icon">üìã</span>
                            <span class="instructions-title">How to Use:</span>
                        </div>
                        <ol class="instructions-list">
                            <li>Click the toggle switch on any control card to turn it ON or OFF</li>
                            <li>The switch will show "Active" when the device is running</li>
                            <li>Monitor the status indicator to see if the command was successful</li>
                            <li>Remember to turn OFF manual controls when done to return to automatic mode</li>
                        </ol>
                    </div>
                    
                    <!-- Status Legend -->
                    <div class="status-legend">
                        <div class="legend-item">
                            <span class="legend-dot legend-green"></span>
                            <span class="legend-text">Green: Device is active and running</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot legend-yellow"></span>
                            <span class="legend-text">Yellow: Command is pending</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot legend-gray"></span>
                            <span class="legend-text">Gray: Device is inactive</span>
                        </div>
                    </div>
                    
                    <div class="control-panel">
                        <div class="control-card">
                            <div class="control-header">
                                <div class="control-icon-wrapper">
                                    <span class="control-icon">üö∞</span>
                                </div>
                                <div class="control-title-group">
                                    <h3 class="control-title">Water Pump</h3>
                                    <div class="control-status-badge" id="pump-status-badge">
                                        <span class="status-dot-indicator"></span>
                                        <span class="status-text-small">Inactive</span>
                                    </div>
                                </div>
                            </div>
                            
                            <p class="control-description">Manually activate the sprinkler system Click the switch to turn on the water pump and start watering your plants through the sprinkler system.</p>
                            
                            <div class="control-toggle-container">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="pump-toggle" onchange="handleToggle('pump', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="toggle-label" id="pump-toggle-label">Click to start sprinkler</span>
                            </div>
                            
                            <div class="control-status-info" id="pump-status-display">
                                <div class="status-info-row">
                                    <span class="status-label">Current State:</span>
                                    <span class="status-value" id="pump-status-value">OFF</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="control-card">
                            <div class="control-header">
                                <div class="control-icon-wrapper">
                                    <span class="control-icon">üíß</span>
                                </div>
                                <div class="control-title-group">
                                    <h3 class="control-title">Solenoid Valve</h3>
                                    <div class="control-status-badge" id="valve-status-badge">
                                        <span class="status-dot-indicator"></span>
                                        <span class="status-text-small">Inactive</span>
                                    </div>
                                </div>
                            </div>
                            
                            <p class="control-description">Manually fill the water tank Click the switch to open the valve and fill the water tank. This ensures you have enough water for irrigation.</p>
                            
                            <div class="control-toggle-container">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="valve-toggle" onchange="handleToggle('valve', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="toggle-label" id="valve-toggle-label">Click to fill tank</span>
                            </div>
                            
                            <div class="control-status-info" id="valve-status-display">
                                <div class="status-info-row">
                                    <span class="status-label">Current State:</span>
                                    <span class="status-value" id="valve-status-value">OFF</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Section -->
                <div class="dashboard-section" id="reports-section">
                    <h2 class="section-title">Reports & Analytics</h2>
                    <p class="section-description">Generate comprehensive reports on system activity, device commands, and sensor data.</p>
                    
                    <!-- Report Type Selector -->
                    <div class="reports-controls">
                        <div class="report-type-selector">
                            <button class="report-type-btn active" data-report="device-commands" onclick="selectReportType('device-commands')">
                                üîß Device Commands
                            </button>
                            <button class="report-type-btn" data-report="user-activity" onclick="selectReportType('user-activity')">
                                üë• User Activity
                            </button>
                            <button class="report-type-btn" data-report="sensor-summary" onclick="selectReportType('sensor-summary')">
                                üìä Sensor Summary
                            </button>
                            <button class="report-type-btn" data-report="system-health" onclick="selectReportType('system-health')">
                                üíö System Health
                            </button>
                            <button class="report-type-btn" data-report="water-usage" onclick="selectReportType('water-usage')">
                                üíß Water Usage
                            </button>
                        </div>
                        
                        <!-- Date Range Filters -->
                        <div class="report-filters" id="reportFilters">
                            <div class="filter-group">
                                <label for="reportStartDate">Start Date:</label>
                                <input type="date" id="reportStartDate" class="filter-input">
                            </div>
                            <div class="filter-group">
                                <label for="reportEndDate">End Date:</label>
                                <input type="date" id="reportEndDate" class="filter-input">
                            </div>
                            <div class="filter-group" id="deviceFilterGroup" style="display: none;">
                                <label for="reportDevice">Device:</label>
                                <select id="reportDevice" class="filter-input">
                                    <option value="all">All Devices</option>
                                    <option value="pump">Pump</option>
                                    <option value="valve">Valve</option>
                                </select>
                            </div>
                            <div class="filter-group" id="statusFilterGroup" style="display: none;">
                                <label for="reportStatus">Status:</label>
                                <select id="reportStatus" class="filter-input">
                                    <option value="all">All Statuses</option>
                                    <option value="SUCCESS">Success</option>
                                    <option value="FAILED">Failed</option>
                                    <option value="PENDING">Pending</option>
                                </select>
                            </div>
                            <button class="btn-primary" onclick="generateReport()">Generate Report</button>
                            <button class="btn-secondary" onclick="exportReport()">Export CSV</button>
                        </div>
                    </div>
                    
                    <!-- Report Loading Indicator -->
                    <div id="reportLoading" class="report-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Generating report...</p>
                    </div>
                    
                    <!-- Report Results Container -->
                    <div id="reportResults" class="report-results"></div>
                </div>
                
                <p id="last-update" class="last-update"></p>
                
                <div style="text-align: center; margin-top: var(--space-2xl);">
                    <button class="btn-logout" onclick="logout()">Logout</button>
                </div>
            </div>
        </main>
        
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">‚ò∞</button>
    </div>

    <script>
        let soilChart = null;
        let environmentChart = null;

        function logout() {
            localStorage.removeItem('userToken');
            localStorage.removeItem('userRole');
            window.location.href = 'login.html';
        }

        function getSoilMoistureStatus(value) {
            if (value === null || value === undefined) return { status: 'unknown', class: '', text: 'No data' };
            if (value < 20) return { status: 'low', class: 'low', text: 'Very Dry - Needs Water' };
            if (value < 40) return { status: 'medium', class: 'medium', text: 'Dry - Monitor Closely' };
            if (value < 70) return { status: 'good', class: 'good', text: 'Optimal' };
            return { status: 'excellent', class: 'excellent', text: 'Well Hydrated' };
        }

        function getTemperatureStatus(value) {
            if (value === null || value === undefined) return { status: 'unknown', text: 'No data' };
            if (value < 10) return { status: 'cold', text: 'Cold' };
            if (value < 20) return { status: 'cool', text: 'Cool' };
            if (value < 30) return { status: 'optimal', text: 'Optimal' };
            if (value < 35) return { status: 'warm', text: 'Warm' };
            return { status: 'hot', text: 'Hot - Monitor' };
        }

        function getHumidityStatus(value) {
            if (value === null || value === undefined) return { status: 'unknown', text: 'No data' };
            if (value < 30) return { status: 'low', text: 'Low Humidity' };
            if (value < 60) return { status: 'optimal', text: 'Optimal' };
            return { status: 'high', text: 'High Humidity' };
        }

        function updateProgressBar(elementId, value, statusClass) {
            const bar = document.getElementById(elementId);
            if (bar) {
                if (value !== null && value !== undefined && value > 0) {
                    bar.style.width = `${Math.min(100, Math.max(0, value))}%`;
                    bar.textContent = `${Math.round(value)}%`;
                    bar.className = `progress-bar ${statusClass}`;
                    bar.style.opacity = '1'; // Full opacity when data is available
                } else {
                    // Loading state
                    bar.style.width = '0%';
                    bar.textContent = '0%';
                    bar.className = 'progress-bar';
                    bar.style.opacity = '0.4'; // Reduced opacity for loading state
                }
            }
        }

        function updateStatusIndicator(elementId, isActive, isWarning = false) {
            const indicator = document.getElementById(elementId);
            if (indicator) {
                const dot = indicator.querySelector('.status-dot');
                const text = indicator.querySelector('.status-text') || indicator.querySelector('span:last-child');
                
                if (isWarning) {
                    if (dot) dot.className = 'status-dot warning';
                    if (text) text.textContent = 'Warning';
                } else if (isActive) {
                    if (dot) dot.className = 'status-dot active';
                    if (text) text.textContent = 'Active';
                } else {
                    if (dot) dot.className = 'status-dot inactive';
                    if (text) text.textContent = 'Inactive';
                }
            }
        }

        function updateWaterLevelStatus(elementId, isLow, isHigh = false) {
            const indicator = document.getElementById(elementId);
            if (indicator) {
                const dot = indicator.querySelector('.status-dot');
                const text = indicator.querySelector('.status-text') || indicator.querySelector('span:last-child');
                
                if (elementId === 'water-low-status') {
                    // For low water level: 1 = Low (warning), 0 = OK
                    if (isLow === 1) {
                        if (dot) dot.className = 'status-dot warning';
                        if (text) text.textContent = 'Low';
                    } else {
                        if (dot) dot.className = 'status-dot active';
                        if (text) text.textContent = 'OK';
                    }
                } else if (elementId === 'water-high-status') {
                    // For high water level: 1 = Full, 0 = OK
                    if (isHigh === 1) {
                        if (dot) dot.className = 'status-dot active';
                        if (text) text.textContent = 'Full';
                    } else {
                        if (dot) dot.className = 'status-dot inactive';
                        if (text) text.textContent = 'OK';
                    }
                }
            }
        }

        function checkAlerts(data) {
            const alerts = [];
            
            // Check soil moisture
            [data.soil_moisture_1_percent, data.soil_moisture_2_percent, data.soil_moisture_3_percent].forEach((val, idx) => {
                if (val !== null && val < 20) {
                    alerts.push({ type: 'danger', message: `‚ö†Ô∏è Soil Sensor ${idx + 1} is very dry (${val}%) - Immediate watering recommended!` });
                } else if (val !== null && val < 30) {
                    alerts.push({ type: 'warning', message: `‚ö†Ô∏è Soil Sensor ${idx + 1} is dry (${val}%) - Consider watering soon.` });
                }
            });
            
            // Check temperature
            if (data.air_temperature_celsius !== null && data.air_temperature_celsius > 35) {
                alerts.push({ type: 'warning', message: `üå°Ô∏è High temperature detected (${data.air_temperature_celsius}¬∞C) - Monitor plant stress.` });
            }
            
            // Check water level
            if (data.water_level_low_status === 1) {
                alerts.push({ type: 'danger', message: 'üö® Water level is LOW - Refill water reservoir immediately!' });
            }
            
            return alerts;
        }

        function displayAlerts(alerts) {
            const container = document.getElementById('alert-container');
            if (alerts.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = alerts.map(alert => 
                `<div class="alert-banner ${alert.type} show">
                    ${alert.message}
                </div>`
            ).join('');
        }

        function updateMiniChart(chartId, values, maxValue, minValue) {
            const chartContainer = document.getElementById(chartId);
            if (!chartContainer) return;
            
            const bars = chartContainer.querySelectorAll('.chart-bar');
            if (!bars || bars.length === 0) return;
            
            // Get the last 6 values
            const recentValues = values.slice(-6);
            
            // If no data, keep loading state (low opacity, default height)
            if (!recentValues || recentValues.length === 0) {
                bars.forEach((bar) => {
                    bar.style.opacity = '0.4';
                });
                return;
            }
            
            const range = maxValue - minValue || 1;
            
            bars.forEach((bar, index) => {
                const value = recentValues[index];
                
                if (value === null || value === undefined || index >= recentValues.length) {
                    // Keep loading state for missing values
                    bar.style.opacity = '0.4';
                } else {
                    // Normalize to 0-100% height, with minimum 15%
                    const normalizedHeight = ((value - minValue) / range) * 100;
                    const heightPercent = Math.max(15, Math.min(100, normalizedHeight));
                    bar.style.height = `${heightPercent}%`;
                    bar.style.opacity = '1';
                }
            });
        }

        function calculateTrend(currentValue, previousValue) {
            if (currentValue === null || previousValue === null || currentValue === undefined || previousValue === undefined) {
                return { icon: '‚Üí', class: 'trend-stable' };
            }
            const diff = currentValue - previousValue;
            // Threshold: 0.5 for temperature, 1 for humidity
            const threshold = Math.abs(currentValue) > 50 ? 1 : 0.5;
            
            if (Math.abs(diff) < threshold) {
                return { icon: '‚Üí', class: 'trend-stable' };
            } else if (diff > 0) {
                return { icon: '‚Üë', class: 'trend-up' };
            } else {
                return { icon: '‚Üì', class: 'trend-down' };
            }
        }

        function updateSensorDisplay(data) {
            // Temperature
            const temp = data.air_temperature_celsius;
            const tempNum = temp !== null && temp !== undefined ? Number(temp) : null;
            const tempElement = document.getElementById('temperature');
            if (tempElement) {
                tempElement.textContent = tempNum !== null && !isNaN(tempNum) ? `${tempNum}¬∞C` : 'N/A';
            }
            const tempStatus = getTemperatureStatus(tempNum);
            const tempStatusElement = document.getElementById('temp-status');
            if (tempStatusElement) {
                tempStatusElement.textContent = tempStatus.text;
            }
            
            // Update temperature progress bar (normalize to 0-100% based on typical range 0-50¬∞C)
            if (tempNum !== null && !isNaN(tempNum)) {
                const tempPercent = Math.min(100, Math.max(0, (tempNum / 50) * 100));
                updateProgressBar('temp-bar', tempPercent, 'good');
            } else {
                updateProgressBar('temp-bar', 0, '');
            }
            
            // Humidity
            const humidity = data.air_humidity_percent;
            const humidityNum = humidity !== null && humidity !== undefined ? Number(humidity) : null;
            const humidityElement = document.getElementById('humidity');
            if (humidityElement) {
                humidityElement.textContent = humidityNum !== null && !isNaN(humidityNum) ? `${humidityNum.toFixed(1)}%` : 'N/A';
            }
            const humidityStatus = getHumidityStatus(humidityNum);
            const humidityStatusElement = document.getElementById('humidity-status');
            if (humidityStatusElement) {
                humidityStatusElement.textContent = humidityStatus.text;
            }
            
            // Update humidity progress bar (already in percentage)
            if (humidityNum !== null && !isNaN(humidityNum)) {
                updateProgressBar('humidity-bar', humidityNum, 'good');
            } else {
                updateProgressBar('humidity-bar', 0, '');
            }
            
            // Soil Moisture Sensors
            const soil1 = data.soil_moisture_1_percent;
            const soil2 = data.soil_moisture_2_percent;
            const soil3 = data.soil_moisture_3_percent;
            
            [soil1, soil2, soil3].forEach((val, idx) => {
                const num = idx + 1;
                const soilNum = val !== null && val !== undefined ? Number(val) : null;
                const soilElement = document.getElementById(`soil${num}`);
                if (soilElement) {
                    soilElement.textContent = soilNum !== null && !isNaN(soilNum) ? `${soilNum.toFixed(2)}%` : 'N/A';
                }
                
                const soilStatus = getSoilMoistureStatus(soilNum);
                const soilStatusElement = document.getElementById(`soil${num}-status`);
                if (soilStatusElement) {
                    soilStatusElement.textContent = soilStatus.text;
                }
                updateProgressBar(`soil${num}-bar`, soilNum !== null && !isNaN(soilNum) ? soilNum : 0, soilStatus.class);
                
                // Update card border color
                const card = document.getElementById(`soil${num}-card`);
                if (card) {
                    if (soilStatus.class === 'low') {
                        card.className = 'widget-card sensor-card danger';
                    } else if (soilStatus.class === 'medium') {
                        card.className = 'widget-card sensor-card warning';
                    } else {
                        card.className = 'widget-card sensor-card';
                    }
                }
            });
            
            // System Status
            updateStatusIndicator('valve-status', data.valve_status === 1);
            updateStatusIndicator('pump-status', data.pump_status === 1);
            updateWaterLevelStatus('water-low-status', data.water_level_low_status);
            updateWaterLevelStatus('water-high-status', null, data.water_level_high_status);
            
            // Last update
            if (data.timestamp) {
                const updateTime = new Date(data.timestamp).toLocaleString();
                document.getElementById('last-update').textContent = `Last updated: ${updateTime}`;
            }
            
            // Alerts
            const alerts = checkAlerts(data);
            displayAlerts(alerts);
        }

        function initializeCharts() {
            const soilCtx = document.getElementById('soilChart');
            const envCtx = document.getElementById('environmentChart');
            
            if (soilCtx) {
                soilChart = new Chart(soilCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'Sensor 1', data: [], borderColor: '#43a047', backgroundColor: 'rgba(67, 160, 71, 0.1)', tension: 0.4 },
                            { label: 'Sensor 2', data: [], borderColor: '#1e88e5', backgroundColor: 'rgba(30, 136, 229, 0.1)', tension: 0.4 },
                            { label: 'Sensor 3', data: [], borderColor: '#ff9800', backgroundColor: 'rgba(255, 152, 0, 0.1)', tension: 0.4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: { display: true, text: 'Soil Moisture Trends (%) - Hourly Average', font: { size: 16 } },
                            legend: { display: true }
                        },
                        scales: {
                            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Moisture %' } }
                        }
                    }
                });
            }
            
            if (envCtx) {
                environmentChart = new Chart(envCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'Temperature (¬∞C)', data: [], borderColor: '#f44336', backgroundColor: 'rgba(244, 67, 54, 0.1)', yAxisID: 'y', tension: 0.4 },
                            { label: 'Humidity (%)', data: [], borderColor: '#2196f3', backgroundColor: 'rgba(33, 150, 243, 0.1)', yAxisID: 'y1', tension: 0.4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            title: { display: true, text: 'Temperature & Humidity Trends - Hourly Average', font: { size: 16 } },
                            legend: { display: true }
                        },
                        scales: {
                            y: { type: 'linear', position: 'left', title: { display: true, text: 'Temperature (¬∞C)' } },
                            y1: { type: 'linear', position: 'right', title: { display: true, text: 'Humidity (%)' }, grid: { drawOnChartArea: false } },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    maxTicksLimit: 12
                                }
                            }
                        }
                    }
                });
            }
        }

        function aggregateByHour(data) {
            // Group data by hour
            const hourlyData = {};
            
            data.forEach(d => {
                const date = new Date(d.timestamp);
                // Create hour key: YYYY-MM-DD-HH
                const hourKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}-${String(date.getHours()).padStart(2, '0')}`;
                
                if (!hourlyData[hourKey]) {
                    hourlyData[hourKey] = {
                        timestamp: d.timestamp,
                        hourLabel: date.toLocaleString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }),
                        soil1: [],
                        soil2: [],
                        soil3: [],
                        temperature: [],
                        humidity: []
                    };
                }
                
                // Collect values for averaging
                if (d.soil_moisture_1_percent !== null && d.soil_moisture_1_percent !== undefined) {
                    hourlyData[hourKey].soil1.push(Number(d.soil_moisture_1_percent));
                }
                if (d.soil_moisture_2_percent !== null && d.soil_moisture_2_percent !== undefined) {
                    hourlyData[hourKey].soil2.push(Number(d.soil_moisture_2_percent));
                }
                if (d.soil_moisture_3_percent !== null && d.soil_moisture_3_percent !== undefined) {
                    hourlyData[hourKey].soil3.push(Number(d.soil_moisture_3_percent));
                }
                if (d.air_temperature_celsius !== null && d.air_temperature_celsius !== undefined) {
                    hourlyData[hourKey].temperature.push(Number(d.air_temperature_celsius));
                }
                if (d.air_humidity_percent !== null && d.air_humidity_percent !== undefined) {
                    hourlyData[hourKey].humidity.push(Number(d.air_humidity_percent));
                }
            });
            
            // Calculate averages and create sorted array
            const aggregated = Object.keys(hourlyData)
                .sort()
                .map(key => {
                    const hour = hourlyData[key];
                    return {
                        timestamp: hour.timestamp,
                        label: hour.hourLabel,
                        soil1: hour.soil1.length > 0 ? hour.soil1.reduce((a, b) => a + b, 0) / hour.soil1.length : null,
                        soil2: hour.soil2.length > 0 ? hour.soil2.reduce((a, b) => a + b, 0) / hour.soil2.length : null,
                        soil3: hour.soil3.length > 0 ? hour.soil3.reduce((a, b) => a + b, 0) / hour.soil3.length : null,
                        temperature: hour.temperature.length > 0 ? hour.temperature.reduce((a, b) => a + b, 0) / hour.temperature.length : null,
                        humidity: hour.humidity.length > 0 ? hour.humidity.reduce((a, b) => a + b, 0) / hour.humidity.length : null
                    };
                });
            
            return aggregated;
        }

        function updateCharts(historyData) {
            if (!historyData || historyData.length === 0) return;
            
            // Aggregate data by hour for cleaner charts
            const hourlyData = aggregateByHour(historyData);
            
            const labels = hourlyData.map(d => d.label);
            
            // Update trend arrows for temperature and humidity (use original data for trends)
            const tempValues = historyData.map(d => d.air_temperature_celsius).filter(v => v !== null && v !== undefined);
            const humidityValues = historyData.map(d => d.air_humidity_percent).filter(v => v !== null && v !== undefined);
            
            // Update trend arrow for temperature
            if (tempValues.length >= 2) {
                const currentTemp = tempValues[tempValues.length - 1];
                const previousTemp = tempValues[tempValues.length - 2];
                const trend = calculateTrend(currentTemp, previousTemp);
                const trendIcon = document.querySelector('#temp-card .trend-icon');
                if (trendIcon) {
                    trendIcon.textContent = trend.icon;
                    trendIcon.className = `trend-icon ${trend.class}`;
                }
            }
            
            // Update trend arrow for humidity
            if (humidityValues.length >= 2) {
                const currentHumidity = humidityValues[humidityValues.length - 1];
                const previousHumidity = humidityValues[humidityValues.length - 2];
                const trend = calculateTrend(currentHumidity, previousHumidity);
                const trendIcon = document.querySelector('#humidity-card .trend-icon');
                if (trendIcon) {
                    trendIcon.textContent = trend.icon;
                    trendIcon.className = `trend-icon ${trend.class}`;
                }
            }
            
            if (soilChart) {
                soilChart.data.labels = labels;
                soilChart.data.datasets[0].data = hourlyData.map(d => d.soil1);
                soilChart.data.datasets[1].data = hourlyData.map(d => d.soil2);
                soilChart.data.datasets[2].data = hourlyData.map(d => d.soil3);
                soilChart.update();
            }
            
            if (environmentChart) {
                environmentChart.data.labels = labels;
                environmentChart.data.datasets[0].data = hourlyData.map(d => d.temperature);
                environmentChart.data.datasets[1].data = hourlyData.map(d => d.humidity);
                environmentChart.update();
            }
        }

        async function fetchSensorData() {
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                return;
            }

            try {
                // Fetch latest data
                const response = await fetch('/api/data/latest', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 404) {
                    document.getElementById('temperature').textContent = 'No data';
                    document.getElementById('humidity').textContent = 'No data';
                    ['soil1', 'soil2', 'soil3'].forEach(id => {
                        document.getElementById(id).textContent = 'No data';
                    });
                    document.getElementById('last-update').textContent = 'No sensor data available. Database is empty.';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to fetch sensor data');
                }

                const data = await response.json();
                updateSensorDisplay(data);
                
                // Fetch historical data for charts
                const historyResponse = await fetch('/api/data/history?hours=24', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (historyResponse.ok) {
                    const historyData = await historyResponse.json();
                    updateCharts(historyData);
                }

            } catch (error) {
                console.error('Error fetching sensor data:', error);
                document.getElementById('last-update').textContent = 'Error loading sensor data.';
            }
        }

        async function handleToggle(device, isOn) {
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                alert('Please log in to send commands.');
                return;
            }

            const state = isOn ? 'ON' : 'OFF';
            const toggle = document.getElementById(`${device}-toggle`);
            const toggleLabel = document.getElementById(`${device}-toggle-label`);
            
            // Disable toggle during request
            if (toggle) toggle.disabled = true;
            if (toggleLabel) toggleLabel.textContent = 'Sending...';

            try {
                const response = await fetch('/api/commands/send', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ device, state })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to send command');
                }

                // Update UI immediately
                updateCommandStatus(device, {
                    desired_state: state,
                    status: 'PENDING',
                    requested_at: new Date().toISOString()
                });

                // Refresh status immediately and then poll
                fetchCommandStatus();

            } catch (error) {
                console.error('Error sending command:', error);
                alert(`Failed to send command: ${error.message}`);
                // Revert toggle on error
                if (toggle) toggle.checked = !isOn;
            } finally {
                // Re-enable toggle
                if (toggle) toggle.disabled = false;
            }
        }

        function updateCommandStatus(device, commandData) {
            const statusValue = document.getElementById(`${device}-status-value`);
            const statusBadge = document.getElementById(`${device}-status-badge`);
            const toggle = document.getElementById(`${device}-toggle`);
            const toggleLabel = document.getElementById(`${device}-toggle-label`);
            const dotIndicator = statusBadge?.querySelector('.status-dot-indicator');
            const statusText = statusBadge?.querySelector('.status-text-small');
            
            if (!commandData) {
                if (statusValue) {
                    statusValue.textContent = 'OFF';
                    statusValue.className = 'status-value';
                }
                if (toggle) toggle.checked = false;
                if (toggleLabel) {
                    toggleLabel.textContent = device === 'pump' ? 'Click to start sprinkler' : 'Click to fill tank';
                }
                if (dotIndicator) {
                    dotIndicator.className = 'status-dot-indicator inactive';
                }
                if (statusText) statusText.textContent = 'Inactive';
                return;
            }
            
            // Format status display
            let statusTextValue = '';
            let statusClass = '';
            let isActive = false;
            let isPending = false;
            
            if (commandData.status === 'PENDING') {
                statusTextValue = 'Pending';
                statusClass = 'pending';
                isActive = commandData.desired_state === 'ON';
                isPending = true;
            } else if (commandData.status === 'SUCCESS') {
                statusTextValue = commandData.actual_state || commandData.desired_state;
                statusClass = 'success';
                isActive = (commandData.actual_state || commandData.desired_state) === 'ON';
            } else if (commandData.status === 'FAILED') {
                statusTextValue = 'Failed';
                statusClass = 'error';
                isActive = false;
            } else {
                statusTextValue = commandData.desired_state || 'OFF';
                statusClass = '';
                isActive = commandData.desired_state === 'ON';
            }

            // Update toggle switch
            if (toggle) {
                toggle.checked = isActive;
            }

            // Update status value
            if (statusValue) {
                statusValue.textContent = statusTextValue;
                statusValue.className = `status-value ${statusClass}`;
            }

            // Update status badge
            if (dotIndicator) {
                if (isPending) {
                    dotIndicator.className = 'status-dot-indicator';
                    dotIndicator.style.background = '#FFC107';
                } else if (isActive) {
                    dotIndicator.className = 'status-dot-indicator active';
                } else {
                    dotIndicator.className = 'status-dot-indicator inactive';
                }
            }
            
            if (statusText) {
                statusText.textContent = isPending ? 'Pending' : (isActive ? 'Active' : 'Inactive');
            }

            // Update toggle label
            if (toggleLabel) {
                if (device === 'pump') {
                    toggleLabel.textContent = isActive ? 'Sprinkler is running' : 'Click to start sprinkler';
                } else {
                    toggleLabel.textContent = isActive ? 'Tank is filling' : 'Click to fill tank';
                }
            }
        }

        async function fetchCommandStatus() {
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                return;
            }

            try {
                const response = await fetch('/api/commands/status', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch command status');
                }

                const data = await response.json();
                
                // Update pump status
                updateCommandStatus('pump', data.pump);
                
                // Update valve status
                updateCommandStatus('valve', data.valve);

            } catch (error) {
                console.error('Error fetching command status:', error);
            }
        }

        // Mobile menu toggle and initialization
        document.addEventListener('DOMContentLoaded', () => {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                });
            }
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(e.target) && 
                    !mobileMenuToggle.contains(e.target) &&
                    sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            });
            
            // Navigation item clicks
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const section = this.getAttribute('data-section');
                    
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Handle special navigation cases
                    if (section === 'chatbot') {
                        window.location.href = 'chatbot.html';
                        return;
                    }
                    
                    if (section === 'dashboard') {
                        // Scroll to top of dashboard
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        return;
                    }
                    
                    // Scroll to section if it exists
                    const targetSection = document.getElementById(`${section}-section`);
                    if (targetSection) {
                        targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        // If section not found, try to scroll to dashboard top
                        if (section !== 'reports') {
                            console.warn(`Section "${section}-section" not found`);
                        }
                    }
                });
            });
            
            const token = localStorage.getItem('userToken');
            const role = localStorage.getItem('userRole');

            if (!token || role !== 'admin') {
                alert('Access Denied. You must be an Admin to view this page.');
                window.location.href = 'login.html';
                return;
            }
            
            // Set user avatar and name
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const userRole = document.getElementById('user-role');
            
            if (userAvatar) userAvatar.textContent = 'A';
            if (userName) userName.textContent = 'Admin User';
            if (userRole) userRole.textContent = 'Administrator';

            initializeCharts();
            fetchSensorData();
            fetchCommandStatus(); // Initial load of command status
            setInterval(fetchSensorData, 30000); // Update every 30 seconds
            setInterval(fetchCommandStatus, 10000); // Poll command status every 10 seconds
            
            // Chatbox Widget Functionality
            const floatingChatbotBtn = document.getElementById('floatingChatbotBtn');
            const chatboxWidget = document.getElementById('chatboxWidget');
            const chatboxClose = document.getElementById('chatboxClose');
            const chatboxOverlay = document.getElementById('chatboxOverlay');
            const chatboxInput = document.getElementById('chatboxInput');
            const chatboxSendBtn = document.getElementById('chatboxSendBtn');
            const chatboxMessages = document.getElementById('chatboxMessages');
            const chatboxExamples = document.getElementById('chatboxExamples');
            
            // Open chatbox
            if (floatingChatbotBtn) {
                floatingChatbotBtn.addEventListener('click', () => {
                    chatboxWidget.classList.add('active');
                    chatboxOverlay.classList.add('active');
                    chatboxInput.focus();
                });
            }
            
            // Close chatbox
            const closeChatbox = () => {
                chatboxWidget.classList.remove('active');
                chatboxOverlay.classList.remove('active');
            };
            
            if (chatboxClose) {
                chatboxClose.addEventListener('click', closeChatbox);
            }
            
            if (chatboxOverlay) {
                chatboxOverlay.addEventListener('click', closeChatbox);
            }
            
            // Example question clicks
            if (chatboxExamples) {
                chatboxExamples.querySelectorAll('.example-question').forEach(example => {
                    example.addEventListener('click', () => {
                        const question = example.getAttribute('data-question');
                        if (question) {
                            chatboxInput.value = question;
                            sendChatboxMessage(question);
                        }
                    });
                });
            }
            
            // Send message
            const sendChatboxMessage = (message) => {
                if (!message.trim()) return;
                
                // Add user message
                addChatboxMessage(message, false);
                
                // Hide examples
                if (chatboxExamples) {
                    chatboxExamples.style.display = 'none';
                }
                
                // Clear input
                if (chatboxInput) {
                    chatboxInput.value = '';
                }
                
                // Show loading
                const loadingId = addChatboxMessage('Thinking...', true, true);
                
                // Send to API (using same webhook as full chatbot)
                const N8N_WEBHOOK_URL = 'https://ecoflow-ublc.app.n8n.cloud/webhook/chatbot';
                
                fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question: message,
                        message: message 
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Remove loading message
                    const loadingMsg = document.getElementById(loadingId);
                    if (loadingMsg) loadingMsg.remove();
                    
                    // Handle different response formats
                    let responseText = '';
                    if (data.response) {
                        responseText = data.response;
                    } else if (data.message) {
                        responseText = data.message;
                    } else if (data.answer) {
                        responseText = data.answer;
                    } else if (typeof data === 'string') {
                        responseText = data;
                    } else {
                        responseText = 'I apologize, but I couldn\'t process your request. Please try again.';
                    }
                    
                    // Add bot response
                    addChatboxMessage(responseText, true);
                })
                .catch(error => {
                    // Remove loading message
                    const loadingMsg = document.getElementById(loadingId);
                    if (loadingMsg) loadingMsg.remove();
                    
                    addChatboxMessage('Sorry, I encountered an error. Please try again later.', true);
                    console.error('Chatbot error:', error);
                });
            };
            
            // Escape HTML to prevent XSS (for user messages)
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            // Clean and format HTML response from bot (remove inline styles, convert to clean HTML)
            const cleanHtmlResponse = (html) => {
                if (!html) return '';
                
                // Create a temporary div to parse HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Remove inline styles from all elements
                const allElements = tempDiv.querySelectorAll('*');
                allElements.forEach(el => {
                    el.removeAttribute('style');
                });
                
                // Convert <br> tags to proper line breaks
                const brTags = tempDiv.querySelectorAll('br');
                brTags.forEach(br => {
                    br.replaceWith(document.createTextNode('\n'));
                });
                
                // Get text content and preserve line breaks
                let text = tempDiv.textContent || tempDiv.innerText || '';
                
                // Convert HTML tags to plain text formatting
                // Handle <strong> and <b> tags
                text = text.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
                text = text.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
                
                // Handle <p> tags - add line breaks
                text = text.replace(/<p[^>]*>/gi, '\n');
                text = text.replace(/<\/p>/gi, '\n');
                
                // Handle <br> and <br/> tags
                text = text.replace(/<br\s*\/?>/gi, '\n');
                
                // Remove remaining HTML tags
                text = text.replace(/<[^>]+>/g, '');
                
                // Decode HTML entities
                text = text.replace(/&nbsp;/g, ' ');
                text = text.replace(/&amp;/g, '&');
                text = text.replace(/&lt;/g, '<');
                text = text.replace(/&gt;/g, '>');
                text = text.replace(/&quot;/g, '"');
                
                // Clean up multiple line breaks
                text = text.replace(/\n{3,}/g, '\n\n');
                text = text.trim();
                
                // Convert **text** to <strong>text</strong> for rendering
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                // Convert line breaks to <br> tags
                text = text.replace(/\n/g, '<br>');
                
                return text;
            };
            
            // Add message to chatbox
            const addChatboxMessage = (text, isBot = false, isLoading = false) => {
                const messageId = 'msg-' + Date.now();
                const messageDiv = document.createElement('div');
                messageDiv.className = `chatbox-message ${isBot ? 'bot-message' : 'user-message'}`;
                messageDiv.id = messageId;
                
                if (isBot) {
                    // For bot messages, clean HTML and render it
                    const cleanedText = isLoading ? 'Thinking...' : cleanHtmlResponse(text);
                    messageDiv.innerHTML = `
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-content">
                            <div class="message-text">${cleanedText}</div>
                        </div>
                    `;
                } else {
                    // For user messages, escape HTML for security
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div class="message-text">${escapeHtml(text)}</div>
                        </div>
                    `;
                }
                
                if (chatboxMessages) {
                    chatboxMessages.appendChild(messageDiv);
                    chatboxMessages.scrollTop = chatboxMessages.scrollHeight;
                }
                
                return messageId;
            };
            
            // Send button click
            if (chatboxSendBtn) {
                chatboxSendBtn.addEventListener('click', () => {
                    if (chatboxInput && chatboxInput.value.trim()) {
                        sendChatboxMessage(chatboxInput.value);
                    }
                });
            }
            
            // Enter key to send
            if (chatboxInput) {
                chatboxInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && chatboxInput.value.trim()) {
                        sendChatboxMessage(chatboxInput.value);
                    }
                });
            }
        });

        // Reports functionality
        let currentReportType = 'device-commands';
        let currentReportData = null;

        function selectReportType(type) {
            currentReportType = type;
            
            // Update button states
            document.querySelectorAll('.report-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-report="${type}"]`).classList.add('active');
            
            // Show/hide relevant filters
            const deviceFilterGroup = document.getElementById('deviceFilterGroup');
            const statusFilterGroup = document.getElementById('statusFilterGroup');
            
            if (type === 'device-commands') {
                deviceFilterGroup.style.display = 'block';
                statusFilterGroup.style.display = 'block';
            } else {
                deviceFilterGroup.style.display = 'none';
                statusFilterGroup.style.display = 'none';
            }
            
            // Clear previous results
            document.getElementById('reportResults').innerHTML = '';
        }

        async function generateReport() {
            const token = localStorage.getItem('userToken');
            if (!token) {
                alert('Please login to generate reports.');
                return;
            }

            const loadingDiv = document.getElementById('reportLoading');
            const resultsDiv = document.getElementById('reportResults');
            
            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';

            try {
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const device = document.getElementById('reportDevice')?.value || 'all';
                const status = document.getElementById('reportStatus')?.value || 'all';

                let url = `/api/reports/${currentReportType}?`;
                const params = new URLSearchParams();
                
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (device !== 'all') params.append('device', device);
                if (status !== 'all') params.append('status', status);
                
                // Add default time ranges for reports that need them
                if (!startDate && !endDate) {
                    if (currentReportType === 'system-health') {
                        params.append('days', '7');
                    } else if (currentReportType === 'sensor-summary') {
                        params.append('hours', '24');
                    } else if (currentReportType === 'water-usage') {
                        params.append('days', '7');
                    }
                }

                url += params.toString();

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        // If response isn't JSON, use the text
                        if (errorText) errorMessage += ` - ${errorText}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                currentReportData = data;
                
                displayReport(data, currentReportType);
                
            } catch (error) {
                console.error('Error generating report:', error);
                resultsDiv.innerHTML = `
                    <div class="report-error">
                        <p>‚ùå Error generating report: ${error.message}</p>
                        <p>Please try again later.</p>
                    </div>
                `;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function displayReport(data, reportType) {
            const resultsDiv = document.getElementById('reportResults');
            let html = '';

            switch (reportType) {
                case 'device-commands':
                    html = displayDeviceCommandsReport(data);
                    break;
                case 'user-activity':
                    html = displayUserActivityReport(data);
                    break;
                case 'sensor-summary':
                    html = displaySensorSummaryReport(data);
                    break;
                case 'system-health':
                    html = displaySystemHealthReport(data);
                    break;
                case 'water-usage':
                    html = displayWaterUsageReport(data);
                    break;
                default:
                    html = '<p>Unknown report type.</p>';
            }

            resultsDiv.innerHTML = html;
        }

        function displayDeviceCommandsReport(data) {
            const { commands, summary } = data;
            
            let html = `
                <div class="report-container">
                    <h3 class="report-title">Device Commands Report</h3>
                    
                    <!-- Summary Cards -->
                    <div class="report-summary-grid">
                        <div class="summary-card">
                            <div class="summary-label">Total Commands</div>
                            <div class="summary-value">${summary.total}</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Success Rate</div>
                            <div class="summary-value">${summary.success_rate}%</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Avg Execution Time</div>
                            <div class="summary-value">${summary.avg_execution_time}s</div>
                        </div>
                    </div>
                    
                    <!-- Breakdown by Device -->
                    <div class="report-breakdown">
                        <h4>By Device</h4>
                        <div class="breakdown-list">
                            ${Object.entries(summary.by_device).map(([device, count]) => 
                                `<div class="breakdown-item">
                                    <span class="breakdown-label">${device.charAt(0).toUpperCase() + device.slice(1)}:</span>
                                    <span class="breakdown-value">${count}</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <!-- Breakdown by Status -->
                    <div class="report-breakdown">
                        <h4>By Status</h4>
                        <div class="breakdown-list">
                            ${Object.entries(summary.by_status).map(([status, count]) => 
                                `<div class="breakdown-item">
                                    <span class="breakdown-label">${status}:</span>
                                    <span class="breakdown-value">${count}</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <!-- Breakdown by User -->
                    <div class="report-breakdown">
                        <h4>By User</h4>
                        <div class="breakdown-list">
                            ${Object.entries(summary.by_user).map(([user, info]) => 
                                `<div class="breakdown-item">
                                    <span class="breakdown-label">${info.username} (${info.role}):</span>
                                    <span class="breakdown-value">${info.count} commands</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <!-- Commands Table -->
                    <div class="report-table-container">
                        <h4>Recent Commands</h4>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Device</th>
                                    <th>Desired State</th>
                                    <th>Actual State</th>
                                    <th>Status</th>
                                    <th>User</th>
                                    <th>Execution Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${commands.slice(0, 50).map(cmd => `
                                    <tr>
                                        <td>${new Date(cmd.requested_at).toLocaleString()}</td>
                                        <td>${cmd.device}</td>
                                        <td>${cmd.desired_state}</td>
                                        <td>${cmd.actual_state || 'N/A'}</td>
                                        <td><span class="status-badge status-${cmd.status.toLowerCase()}">${cmd.status}</span></td>
                                        <td>${cmd.username || 'Unknown'}</td>
                                        <td>${cmd.execution_time_seconds ? cmd.execution_time_seconds + 's' : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            return html;
        }

        function displayUserActivityReport(data) {
            let html = `
                <div class="report-container">
                    <h3 class="report-title">User Activity Report</h3>
                    <div class="report-table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Total Commands</th>
                                    <th>Successful</th>
                                    <th>Failed</th>
                                    <th>Pending</th>
                                    <th>First Command</th>
                                    <th>Last Command</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(user => `
                                    <tr>
                                        <td>${user.username}</td>
                                        <td>${user.email}</td>
                                        <td>${user.user_role}</td>
                                        <td><span class="status-badge ${user.is_active ? 'status-success' : 'status-failed'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                                        <td>${user.total_commands || 0}</td>
                                        <td>${user.successful_commands || 0}</td>
                                        <td>${user.failed_commands || 0}</td>
                                        <td>${user.pending_commands || 0}</td>
                                        <td>${user.first_command ? new Date(user.first_command).toLocaleString() : 'N/A'}</td>
                                        <td>${user.last_command ? new Date(user.last_command).toLocaleString() : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            return html;
        }

        function displaySensorSummaryReport(data) {
            const { summary, thresholds } = data;
            
            let html = `
                <div class="report-container">
                    <h3 class="report-title">Sensor Data Summary Report</h3>
                    
                    <div class="report-summary-grid">
                        <div class="summary-card">
                            <div class="summary-label">Total Readings</div>
                            <div class="summary-value">${summary.total_readings || 0}</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">First Reading</div>
                            <div class="summary-value-small">${summary.first_reading ? new Date(summary.first_reading).toLocaleString() : 'N/A'}</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Last Reading</div>
                            <div class="summary-value-small">${summary.last_reading ? new Date(summary.last_reading).toLocaleString() : 'N/A'}</div>
                        </div>
                    </div>
                    
                    <div class="report-breakdown">
                        <h4>Soil Moisture Averages</h4>
                        <div class="breakdown-list">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Sensor 1:</span>
                                <span class="breakdown-value">Avg: ${Number(summary.avg_soil1 || 0).toFixed(2)}% (Min: ${Number(summary.min_soil1 || 0).toFixed(2)}%, Max: ${Number(summary.max_soil1 || 0).toFixed(2)}%)</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Sensor 2:</span>
                                <span class="breakdown-value">Avg: ${Number(summary.avg_soil2 || 0).toFixed(2)}% (Min: ${Number(summary.min_soil2 || 0).toFixed(2)}%, Max: ${Number(summary.max_soil2 || 0).toFixed(2)}%)</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Sensor 3:</span>
                                <span class="breakdown-value">Avg: ${Number(summary.avg_soil3 || 0).toFixed(2)}% (Min: ${Number(summary.min_soil3 || 0).toFixed(2)}%, Max: ${Number(summary.max_soil3 || 0).toFixed(2)}%)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="report-breakdown">
                        <h4>Environmental Conditions</h4>
                        <div class="breakdown-list">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Temperature:</span>
                                <span class="breakdown-value">Avg: ${Number(summary.avg_temperature || 0).toFixed(2)}¬∞C (Min: ${Number(summary.min_temperature || 0).toFixed(2)}¬∞C, Max: ${Number(summary.max_temperature || 0).toFixed(2)}¬∞C)</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Humidity:</span>
                                <span class="breakdown-value">Avg: ${Number(summary.avg_humidity || 0).toFixed(2)}% (Min: ${Number(summary.min_humidity || 0).toFixed(2)}%, Max: ${Number(summary.max_humidity || 0).toFixed(2)}%)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="report-breakdown">
                        <h4>System Status</h4>
                        <div class="breakdown-list">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Pump ON Count:</span>
                                <span class="breakdown-value">${summary.pump_on_count || 0}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Valve ON Count:</span>
                                <span class="breakdown-value">${summary.valve_on_count || 0}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Low Water Alerts:</span>
                                <span class="breakdown-value">${summary.low_water_alerts || 0}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">High Water Alerts:</span>
                                <span class="breakdown-value">${summary.high_water_alerts || 0}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${thresholds.low_moisture_count > 0 ? `
                        <div class="report-alert">
                            <h4>‚ö†Ô∏è Low Moisture Alerts</h4>
                            <p>Found ${thresholds.low_moisture_count} readings with soil moisture below 20%</p>
                            <p>First occurrence: ${thresholds.first_low_moisture ? new Date(thresholds.first_low_moisture).toLocaleString() : 'N/A'}</p>
                            <p>Last occurrence: ${thresholds.last_low_moisture ? new Date(thresholds.last_low_moisture).toLocaleString() : 'N/A'}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            return html;
        }

        function displaySystemHealthReport(data) {
            const statusClass = data.overall_status === 'healthy' ? 'status-success' : 
                              data.overall_status === 'warning' ? 'status-pending' : 'status-failed';
            
            let html = `
                <div class="report-container">
                    <h3 class="report-title">System Health Report (Last ${data.period_days} Days)</h3>
                    
                    <div class="report-summary-grid">
                        <div class="summary-card">
                            <div class="summary-label">Overall Status</div>
                            <div class="summary-value"><span class="status-badge ${statusClass}">${data.overall_status.toUpperCase()}</span></div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Command Success Rate</div>
                            <div class="summary-value">${data.commands.total_commands > 0 ? ((Number(data.commands.successful) / Number(data.commands.total_commands)) * 100).toFixed(2) : 0}%</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Hours Since Last Reading</div>
                            <div class="summary-value">${data.sensors.hours_since_last_reading || 0}</div>
                        </div>
                    </div>
                    
                    <div class="report-breakdown">
                        <h4>Command Statistics</h4>
                        <div class="breakdown-list">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Total Commands:</span>
                                <span class="breakdown-value">${data.commands.total_commands || 0}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Successful:</span>
                                <span class="breakdown-value">${data.commands.successful || 0}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Failed:</span>
                                <span class="breakdown-value">${data.commands.failed || 0}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Pending:</span>
                                <span class="breakdown-value">${data.commands.pending || 0}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Avg Response Time:</span>
                                <span class="breakdown-value">${Number(data.commands.avg_response_time || 0).toFixed(2)}s</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="report-breakdown">
                        <h4>Sensor Data Availability</h4>
                        <div class="breakdown-list">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Total Readings:</span>
                                <span class="breakdown-value">${data.sensors.total_readings || 0}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Days with Data:</span>
                                <span class="breakdown-value">${data.sensors.days_with_data || 0}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Oldest Reading:</span>
                                <span class="breakdown-value">${data.sensors.oldest_reading ? new Date(data.sensors.oldest_reading).toLocaleString() : 'N/A'}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">Newest Reading:</span>
                                <span class="breakdown-value">${data.sensors.newest_reading ? new Date(data.sensors.newest_reading).toLocaleString() : 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="report-breakdown">
                        <h4>Device Performance</h4>
                        <div class="breakdown-list">
                            ${data.devices.map(device => `
                                <div class="breakdown-item">
                                    <span class="breakdown-label">${device.device.charAt(0).toUpperCase() + device.device.slice(1)}:</span>
                                    <span class="breakdown-value">
                                        ${device.total_commands || 0} commands, 
                                        ${device.successful_ons || 0} successful ONs, 
                                        ${device.failures || 0} failures
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="report-breakdown">
                        <h4>Water Level Alerts</h4>
                        <div class="breakdown-list">
                            <div class="breakdown-item">
                                <span class="breakdown-label">Low Water Alerts:</span>
                                <span class="breakdown-value">${data.water_alerts.low_water_count || 0}</span>
                            </div>
                            <div class="breakdown-item">
                                <span class="breakdown-label">High Water Alerts:</span>
                                <span class="breakdown-value">${data.water_alerts.high_water_count || 0}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function displayWaterUsageReport(data) {
            const { usage, commands } = data;
            
            let html = `
                <div class="report-container">
                    <h3 class="report-title">Water Usage Report</h3>
                    
                    <div class="report-summary-grid">
                        <div class="summary-card">
                            <div class="summary-label">Pump Activations</div>
                            <div class="summary-value">${usage.pump.total_activations || 0}</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Pump Total ON Time</div>
                            <div class="summary-value">${usage.pump.total_on_time_minutes || 0} min</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Valve Activations</div>
                            <div class="summary-value">${usage.valve.total_activations || 0}</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Valve Total ON Time</div>
                            <div class="summary-value">${usage.valve.total_on_time_minutes || 0} min</div>
                        </div>
                    </div>
                    
                    <div class="report-breakdown">
                        <h4>Daily Usage Breakdown</h4>
                        <div class="breakdown-list">
                            ${Object.entries(usage.pump.by_date).map(([date, stats]) => `
                                <div class="breakdown-item">
                                    <span class="breakdown-label">${date} - Pump:</span>
                                    <span class="breakdown-value">${stats.activations} activations, ${stats.on_time_minutes} min ON time</span>
                                </div>
                            `).join('')}
                            ${Object.entries(usage.valve.by_date).map(([date, stats]) => `
                                <div class="breakdown-item">
                                    <span class="breakdown-label">${date} - Valve:</span>
                                    <span class="breakdown-value">${stats.activations} activations, ${stats.on_time_minutes} min ON time</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="report-table-container">
                        <h4>Recent Commands</h4>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Device</th>
                                    <th>State</th>
                                    <th>Status</th>
                                    <th>Requested At</th>
                                    <th>Executed At</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${commands.slice(0, 50).map(cmd => `
                                    <tr>
                                        <td>${cmd.date}</td>
                                        <td>${cmd.device}</td>
                                        <td>${cmd.desired_state}</td>
                                        <td><span class="status-badge status-${cmd.status.toLowerCase()}">${cmd.status}</span></td>
                                        <td>${new Date(cmd.requested_at).toLocaleString()}</td>
                                        <td>${cmd.executed_at ? new Date(cmd.executed_at).toLocaleString() : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            return html;
        }

        function exportReport() {
            if (!currentReportData) {
                alert('Please generate a report first before exporting.');
                return;
            }

            // Simple CSV export for device commands report
            if (currentReportType === 'device-commands' && currentReportData.commands) {
                const headers = ['Time', 'Device', 'Desired State', 'Actual State', 'Status', 'User', 'Execution Time'];
                const rows = currentReportData.commands.map(cmd => [
                    new Date(cmd.requested_at).toLocaleString(),
                    cmd.device,
                    cmd.desired_state,
                    cmd.actual_state || 'N/A',
                    cmd.status,
                    cmd.username || 'Unknown',
                    cmd.execution_time_seconds ? cmd.execution_time_seconds + 's' : 'N/A'
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `device-commands-report-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            } else {
                alert('CSV export is currently only available for Device Commands report.');
            }
        }
    </script>
    
    <!-- Floating Chatbot Button -->
    <button class="floating-chatbot-btn" id="floatingChatbotBtn" aria-label="Open AI Chatbot">
        <span class="chatbot-icon">üí¨</span>
        <span class="chatbot-tooltip">AI Chatbot</span>
    </button>
    
    <!-- Chatbox Widget -->
    <div class="chatbox-widget" id="chatboxWidget">
        <div class="chatbox-header">
            <div class="chatbox-header-content">
                <div class="chatbox-avatar">ü§ñ</div>
                <div class="chatbox-title-group">
                    <h3 class="chatbox-title">AI Irrigation Chatbot</h3>
                    <p class="chatbox-subtitle">Ask about your irrigation system</p>
                </div>
            </div>
            <button class="chatbox-close" id="chatboxClose" aria-label="Close chatbox">√ó</button>
        </div>
        
        <div class="chatbox-messages" id="chatboxMessages">
            <div class="chatbox-message bot-message">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="message-text">
                        Hello! I'm your AI irrigation assistant. I can help you with:
                        <ul>
                            <li>Current soil conditions and sensor readings</li>
                            <li>Crop suitability based on environmental data</li>
                            <li>Historical sensor data analysis</li>
                            <li>Irrigation schedule recommendations</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chatbox-examples" id="chatboxExamples">
            <div class="example-question" data-question="What is the current soil moisture level?">
                What is the current soil moisture level?
            </div>
            <div class="example-question" data-question="What crops are suitable for the current conditions?">
                What crops are suitable?
            </div>
            <div class="example-question" data-question="When should I water my plants?">
                When should I water my plants?
            </div>
        </div>
        
        <div class="chatbox-input-container">
            <input 
                type="text" 
                id="chatboxInput" 
                class="chatbox-input" 
                placeholder="Ask me about your irrigation system..."
                autocomplete="off"
            />
            <button id="chatboxSendBtn" class="chatbox-send-btn" aria-label="Send message">
                <span class="send-icon">üì§</span>
            </button>
        </div>
    </div>
    
    <div class="chatbox-overlay" id="chatboxOverlay"></div>
</body>
</html>
